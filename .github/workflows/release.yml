name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    name: Build MSI and publish GitHub Release
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true
          shared-key: "release"

      - name: Build release binary
        run: cargo build --release --target x86_64-pc-windows-msvc --locked

      - name: Install cargo-wix
        run: cargo install cargo-wix --version "0.3.9" --locked

      - name: Add WiX v3 to PATH
        shell: bash
        run: echo "C:/Program Files (x86)/WiX Toolset v3.11/bin" >> "$GITHUB_PATH"

      - name: Build MSI installer
        run: cargo wix --target x86_64-pc-windows-msvc --nocapture

      - name: Locate MSI artifact
        id: msi
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "target\wix\*.msi" | Select-Object -First 1
          echo "path=$($msi.FullName)" >> $env:GITHUB_OUTPUT
          echo "name=$($msi.Name)" >> $env:GITHUB_OUTPUT

      - name: Get release version
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: smb-watch ${{ steps.version.outputs.tag }}
          body: |
            ## smb-watch ${{ steps.version.outputs.tag }}

            ### Installation
            Download `${{ steps.msi.outputs.name }}` and run it.
            Installs `smb-watch.exe` to `C:\Program Files\smb-watch\`.

            ### Requirements
            - Windows x64
          files: ${{ steps.msi.outputs.path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
